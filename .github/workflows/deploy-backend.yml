name: Deploy Backend

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag (default: latest)'
        required: false
        default: 'latest'
  repository_dispatch:
    types: [backend-updated]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout deploy repository
        uses: actions/checkout@v4
      
      - name: Set image tag
        id: image_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull Docker image
        run: |
          docker pull ghcr.io/evgeniybardik/loadmaster-api:${{ steps.image_tag.outputs.tag }} || \
          docker pull ghcr.io/evgeniybardik/loadmaster-api:latest
      
      - name: Tag image for local use
        run: |
          docker tag ghcr.io/evgeniybardik/loadmaster-api:${{ steps.image_tag.outputs.tag }} loadmaster-api:latest || \
          docker tag ghcr.io/evgeniybardik/loadmaster-api:latest loadmaster-api:latest
      
      # Add deployment steps here
      # Example: kubectl set image deployment/backend backend=ghcr.io/evgeniybardik/loadmaster-api:${{ steps.image_tag.outputs.tag }}
