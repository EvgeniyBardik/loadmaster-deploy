name: Deploy Backend

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag (default: latest)'
        required: false
        default: 'latest'
  repository_dispatch:
    types: [backend-updated]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout deploy repository
        uses: actions/checkout@v4
      
      - name: Set image tag
        id: image_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      
      - name: Set image tag
        id: final_tag
        run: |
          TAG="${{ steps.image_tag.outputs.tag }}"
          if [ "$TAG" == "latest" ]; then
            echo "image=ghcr.io/evgeniybardik/loadmaster-api:latest" >> $GITHUB_OUTPUT
          else
            echo "image=ghcr.io/evgeniybardik/loadmaster-api:$TAG" >> $GITHUB_OUTPUT
          fi
      
      - name: Update backend deployment
        run: |
          kubectl set image deployment/backend backend=${{ steps.final_tag.outputs.image }} -n loadmaster
          kubectl rollout status deployment/backend -n loadmaster --timeout=5m
      
      - name: Verify deployment
        run: |
          kubectl get pods -n loadmaster -l app=backend
          kubectl get svc -n loadmaster
