name: Deploy Worker

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag (default: latest)'
        required: false
        default: 'latest'
  repository_dispatch:
    types: [worker-updated]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout deploy repository
        uses: actions/checkout@v4
      
      - name: Set image tag
        id: image_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            SHA="${{ github.event.client_payload.short_sha }}"
            if [ -n "$SHA" ]; then
              echo "tag=$SHA" >> $GITHUB_OUTPUT
            else
              echo "tag=latest" >> $GITHUB_OUTPUT
            fi
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      
      - name: Set final image
        id: final_image
        run: |
          TAG="${{ steps.image_tag.outputs.tag }}"
          echo "image=ghcr.io/evgeniybardik/loadmaster-worker:$TAG" >> $GITHUB_OUTPUT
      
      - name: Update worker deployment
        run: |
          kubectl set image deployment/worker worker=${{ steps.final_image.outputs.image }} -n loadmaster
          kubectl rollout status deployment/worker -n loadmaster --timeout=5m
      
      - name: Verify deployment
        run: |
          kubectl get pods -n loadmaster -l app=worker
          kubectl get svc -n loadmaster
      
      - name: Cleanup old pods
        run: |
          kubectl delete pods -n loadmaster -l app=worker --field-selector=status.phase==Succeeded --grace-period=0 || true
          kubectl delete pods -n loadmaster -l app=worker --field-selector=status.phase==Failed --grace-period=0 || true
